<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ACV Interactive Dashboard - Powersemiotics</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=DM+Serif+Display&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8B5CF6",
                        "primary-hover": "#7C3AED",
                        "secondary": "#EC4899",
                        "danger": "#e11d48",
                        "warning": "#f59e0b",
                        "success": "#10b981",
                        "background-light": "#f6f7f8",
                        "background-dark": "#0F172A",
                        "card-light": "#ffffff",
                        "card-dark": "#1E293B",
                        "text-primary-light": "#1E293B",
                        "text-primary-dark": "#F8FAFC",
                        "text-secondary-light": "#64748B",
                        "text-secondary-dark": "#94A3B8",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "serif": ["'DM Serif Display'", "serif"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style>
        .brain-area {
            transition: all 0.3s ease;
            cursor: pointer;
            opacity: 0.4;
        }

        .brain-area:hover,
        .brain-area.active {
            opacity: 0.8;
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.5));
        }

        .area-aca {
            fill: #EF4444;
        }

        .area-mca {
            fill: #EAB308;
        }

        .area-pca {
            fill: #3B82F6;
        }

        .brain-outline {
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        .gradient-text {
            background: linear-gradient(90deg, #8B5CF6 0%, #EC4899 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Hide native radio buttons but keep them accessible */
        .sr-only-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        input[type="radio"]:checked+div {
            border-color: #8B5CF6;
            background-color: rgba(139, 92, 246, 0.05);
        }

        input[type="radio"]:checked+div .radio-circle {
            border-color: #8B5CF6;
            background-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        input[type="radio"]:checked+div .radio-dot {
            opacity: 1;
        }

        @keyframes scan {

            0%,
            100% {
                top: 0%;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .scan-line {
            animation: scan 4s ease-in-out infinite;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-text-primary-light dark:text-text-primary-dark min-h-screen flex flex-col transition-colors duration-300">

    <!-- Header Section -->
    <header
        class="sticky top-0 z-50 bg-card-light dark:bg-card-dark border-b border-gray-200 dark:border-gray-800 shadow-sm backdrop-blur-md">
        <div class="px-6 py-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="size-10 bg-primary/10 rounded-lg flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-2xl">neurology</span>
                </div>
                <div>
                    <h2 class="text-xl font-bold leading-tight font-serif tracking-wide">ACV Unified Dashboard</h2>
                    <p
                        class="text-[10px] text-text-secondary-light dark:text-text-secondary-dark uppercase tracking-widest font-bold">
                        Guías AHA/ASA 2024 • Powersemiotics</p>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div
                    class="hidden md:flex items-center gap-4 bg-gray-50 dark:bg-gray-800/50 px-4 py-2 rounded-full border border-gray-100 dark:border-gray-700">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] font-bold text-primary uppercase">Usuario</span>
                        <span class="text-sm font-semibold" id="user-display">Invitado</span>
                    </div>
                    <div class="h-8 w-px bg-gray-200 dark:bg-gray-700"></div>
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold text-danger uppercase tracking-tighter">Gold Standard</span>
                        <span class="text-lg font-bold font-mono leading-none flex items-center gap-1"
                            id="timer-display">00:00:00</span>
                    </div>
                </div>

                <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                    onclick="document.documentElement.classList.toggle('dark')">
                    <span class="material-symbols-outlined text-xl">dark_mode</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-[1600px] mx-auto w-full p-4 md:p-6 lg:p-8 flex flex-col gap-8">

        <!-- Top Interaction Section: Mapper & Simulator -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Mapper Card (Lg: 4/12) -->
            <div
                class="lg:col-span-5 bg-card-light dark:bg-card-dark rounded-3xl shadow-xl border border-gray-100 dark:border-gray-800 p-8 flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-primary/20 pointer-events-none scan-line"></div>

                <div class="mb-6">
                    <h3 class="font-serif text-3xl text-gray-900 dark:text-white mb-2">Mapeo <span
                            class="gradient-text">Neuro-Vascular</span></h3>
                    <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark font-medium">Selecciona el
                        territorio vascular para cargar un caso clínico.</p>
                </div>

                <div class="flex-1 flex items-center justify-center py-4">
                    <svg class="w-full max-w-sm drop-shadow-2xl text-gray-300 dark:text-gray-600" viewBox="0 0 400 300">
                        <path class="brain-outline stroke-current"
                            d="M100,250 Q60,240 50,180 Q40,100 120,60 Q200,30 280,60 Q360,100 350,180 Q340,240 300,250 Q200,270 100,250 Z">
                        </path>
                        <path class="brain-area area-aca" id="btn-aca" onclick="selectTerritory('ACA')"
                            d="M120,60 Q160,50 200,50 Q240,50 280,60 Q260,100 240,120 Q200,130 160,120 Q140,100 120,60 Z">
                        </path>
                        <path class="brain-area area-mca" id="btn-mca-dom" onclick="selectTerritory('ACM-DOM')"
                            d="M160,120 L160,180 Q120,180 80,230 Q60,220 50,180 Q60,120 120,60 Q140,100 160,120 Z">
                        </path>
                        <path class="brain-area area-mca" id="btn-mca-non" onclick="selectTerritory('ACM-NON')"
                            d="M160,120 Q200,130 240,120 Q260,100 280,60 Q340,120 350,180 Q340,220 320,230 Q280,180 200,180 Q240,180 240,180 L240,120 Z">
                        </path>
                        <path class="brain-area area-pca" id="btn-acp" onclick="selectTerritory('ACP')"
                            d="M80,230 Q120,180 200,180 Q280,180 320,230 Q300,250 200,270 Q100,250 80,230 Z"></path>

                        <text fill="white" font-size="10" font-weight="bold" pointer-events="none" text-anchor="middle"
                            x="200" y="85">ACA</text>
                        <text fill="white" font-size="10" font-weight="bold" pointer-events="none" text-anchor="middle"
                            x="110" y="160">ACM (I)</text>
                        <text fill="white" font-size="10" font-weight="bold" pointer-events="none" text-anchor="middle"
                            x="290" y="160">ACM (D)</text>
                        <text fill="white" font-size="10" font-weight="bold" pointer-events="none" text-anchor="middle"
                            x="200" y="235">ACP</text>
                    </svg>
                </div>

                <div class="grid grid-cols-3 gap-2 mt-6">
                    <div
                        class="flex items-center gap-2 p-2 rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30">
                        <div class="size-2 rounded-full bg-red-500"></div>
                        <span class="text-[10px] font-bold text-red-700 dark:text-red-400">ACA</span>
                    </div>
                    <div
                        class="flex items-center gap-2 p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30">
                        <div class="size-2 rounded-full bg-yellow-500"></div>
                        <span class="text-[10px] font-bold text-yellow-700 dark:text-yellow-400">ACM</span>
                    </div>
                    <div
                        class="flex items-center gap-2 p-2 rounded-lg bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30">
                        <div class="size-2 rounded-full bg-blue-500"></div>
                        <span class="text-[10px] font-bold text-blue-700 dark:text-blue-400">ACP</span>
                    </div>
                </div>
            </div>

            <!-- Stroke Simulator (Lg: 8/12) -->
            <div
                class="lg:col-span-7 bg-card-light dark:bg-card-dark rounded-3xl shadow-xl border border-gray-100 dark:border-gray-800 p-8 flex flex-col gap-6">

                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <span
                            class="px-2 py-1 text-[10px] font-black bg-primary text-white rounded-full uppercase tracking-widest mb-2 inline-block"
                            id="case-category">Territorio Pendiente</span>
                        <h1 class="text-3xl font-black leading-tight tracking-tight" id="patient-title">Selección
                            Requerida</h1>
                    </div>
                    <div class="flex items-center gap-2 bg-background-light dark:bg-background-dark p-2 rounded-xl">
                        <button
                            class="p-2 bg-white dark:bg-slate-700 rounded-lg shadow-sm hover:text-primary transition-all"
                            onclick="resetCurrentCase()">
                            <span class="material-symbols-outlined text-lg">restart_alt</span>
                        </button>
                        <span class="text-xs font-bold px-2 uppercase tracking-wide opacity-50" id="case-id">ID:
                            ----</span>
                    </div>
                </div>

                <div
                    class="bg-background-light dark:bg-slate-800/50 p-6 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <p class="text-lg text-text-primary-light dark:text-text-primary-dark leading-relaxed font-medium"
                        id="case-desc">
                        Por favor, selecciona un área en el mapa vascular para comenzar el análisis del paciente
                        hiperagudo.
                    </p>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex flex-col border-l-2 border-primary pl-4">
                            <span
                                class="text-[10px] uppercase font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Last
                                Known Well (LKW)</span>
                            <span class="text-sm font-black" id="val-lkw">--:--</span>
                        </div>
                        <div class="flex flex-col border-l-2 border-primary pl-4">
                            <span
                                class="text-[10px] uppercase font-bold text-text-secondary-light dark:text-text-secondary-dark mb-1">Antecedentes
                                Relevantes</span>
                            <span class="text-sm font-black" id="val-history">---</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div
                        class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 text-center flex flex-col items-center">
                        <span
                            class="text-[10px] font-black text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Presión
                            Arterial</span>
                        <span class="text-2xl font-black text-danger" id="vital-bp">--/--</span>
                        <span class="text-[10px] font-bold text-gray-400">mmHg</span>
                    </div>
                    <div
                        class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 text-center flex flex-col items-center">
                        <span
                            class="text-[10px] font-black text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Frec.
                            Cardiaca</span>
                        <span class="text-2xl font-black" id="vital-hr">--</span>
                        <span class="text-[10px] font-bold text-gray-400">LPM</span>
                    </div>
                    <div
                        class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 text-center flex flex-col items-center">
                        <span
                            class="text-[10px] font-black text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Saturación
                            O2</span>
                        <span class="text-2xl font-black" id="vital-sat">--</span>
                        <span class="text-[10px] font-bold text-gray-400">%</span>
                    </div>
                    <div
                        class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 text-center flex flex-col items-center">
                        <span
                            class="text-[10px] font-black text-text-secondary-light dark:text-text-secondary-dark uppercase mb-1">Glucemia</span>
                        <span class="text-2xl font-black" id="vital-gluc">--</span>
                        <span class="text-[10px] font-bold text-gray-400">mg/dL</span>
                    </div>
                </div>

                <!-- Urgent Actions Row -->
                <div class="mt-4 flex flex-wrap gap-3">
                    <button
                        class="flex-1 min-w-[150px] group flex flex-col items-center gap-2 p-4 bg-primary text-white rounded-2xl shadow-lg shadow-primary/20 hover:scale-[1.02] transition-all disabled:opacity-50 disabled:grayscale"
                        onclick="performAction('TC')" id="action-tc">
                        <span class="material-symbols-outlined text-3xl">radiology</span>
                        <span class="text-xs font-bold uppercase tracking-wider">Descartar Hemorragia (TC)</span>
                    </button>
                    <button
                        class="flex-1 min-w-[150px] group flex flex-col items-center gap-2 p-4 bg-indigo-600 text-white rounded-2xl shadow-lg shadow-indigo-600/20 hover:scale-[1.02] transition-all disabled:opacity-50"
                        onclick="performAction('BP')" id="action-bp">
                        <span class="material-symbols-outlined text-3xl">blood_pressure</span>
                        <span class="text-xs font-bold uppercase tracking-wider">Controlar PA (Meta &lt;185)</span>
                    </button>
                    <button
                        class="flex-1 min-w-[150px] group flex flex-col items-center gap-2 p-4 bg-purple-600 text-white rounded-2xl shadow-lg shadow-purple-600/20 hover:scale-[1.02] transition-all disabled:opacity-50"
                        onclick="performAction('TNK')" id="action-tnk">
                        <span class="material-symbols-outlined text-3xl">medication_liquid</span>
                        <span class="text-xs font-bold uppercase tracking-wider">Trombolizar (TNK)</span>
                    </button>
                </div>

                <div id="status-banner" class="hidden p-4 rounded-2xl border-l-4 font-bold text-sm animate-pulse"></div>
            </div>
        </div>

        <!-- Bottom Section: NIHSS Assessment -->
        <div
            class="bg-card-light dark:bg-card-dark rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-800 overflow-hidden">
            <div
                class="bg-primary/5 dark:bg-primary/10 px-8 py-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 bg-primary rounded-2xl flex items-center justify-center text-white shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-3xl">analytics</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black tracking-tight">Escala NIHSS Integradora</h2>
                        <p class="text-sm font-bold text-text-secondary-light dark:text-text-secondary-dark">Evaluación
                            sistemática del déficit neurológico</p>
                    </div>
                </div>
                <div class="hidden md:flex items-center gap-6">
                    <div class="text-right">
                        <p class="text-[10px] font-black uppercase text-primary">Interpretación</p>
                        <p class="text-lg font-black" id="nihss-interpretation">No Evaluativo</p>
                    </div>
                    <div class="bg-white dark:bg-slate-700 px-6 py-3 rounded-2xl flex items-center gap-3 shadow-inner">
                        <span class="text-sm font-black opacity-50 uppercase">Score Total</span>
                        <span class="text-4xl font-black text-primary" id="nihss-score-total">0</span>
                    </div>
                </div>
            </div>

            <div class="p-8 grid grid-cols-1 lg:grid-cols-12 gap-12">
                <!-- Left: Scale Categories -->
                <div class="lg:col-span-8 flex flex-col gap-8" id="nihss-form-container">
                    <!-- Secciones se cargarán dinámicamente -->
                    <div
                        class="flex flex-col items-center justify-center py-20 text-text-secondary-light dark:text-text-secondary-dark">
                        <span class="material-symbols-outlined text-6xl opacity-20 mb-4">clinical_notes</span>
                        <p class="font-bold">Cargando ítems de evaluación...</p>
                    </div>
                </div>

                <!-- Right: Submission & Points -->
                <div class="lg:col-span-4 sticky top-24 h-fit space-y-6">
                    <div
                        class="bg-background-light dark:bg-slate-800/50 rounded-3xl p-8 border border-gray-100 dark:border-gray-700">
                        <h3 class="font-black text-xl mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-success">verified</span>
                            Ranking del Estudiante
                        </h3>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold opacity-60">Aciertos Clínicos</span>
                                <span class="text-xl font-black text-success" id="hit-count">0</span>
                            </div>
                            <div class="h-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-success transition-all duration-500" id="hit-progress"
                                    style="width: 0%"></div>
                            </div>

                            <div class="flex justify-between items-center mt-6">
                                <span class="text-sm font-bold opacity-60">Errores de Protocolo</span>
                                <span class="text-xl font-black text-danger" id="error-count">0</span>
                            </div>
                            <div class="h-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-danger transition-all duration-500" id="error-progress"
                                    style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="mt-10 pt-8 border-t border-gray-200 dark:border-gray-700 flex flex-col gap-4">
                            <button
                                class="w-full bg-primary hover:bg-primary-hover text-white font-black py-5 rounded-2xl shadow-xl shadow-primary/30 transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                                id="btn-save-nihss" onclick="saveEvaluation()">
                                <span class="material-symbols-outlined">save</span>
                                GUARDAR EVALUACIÓN
                            </button>
                            <p class="text-[10px] text-center font-bold opacity-40 uppercase">Los datos se sincronizarán
                                con tu perfil de Supabase</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuración de Supabase (Sustituye con tus credenciales reales)
        const SUPABASE_URL = "https://dyfjawopnbkjrjsnhbyn.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_9fyCTrHL9ArHojgrTMSX1A_UlwZSOCa";
        let supabaseClient = null;
        let currentUser = null;

        if (SUPABASE_URL !== "https://your-project.supabase.co") {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Datos Médicos: 5 Casos Clínicos
        const CLINICAL_CASES = {
            'ACA': {
                id: 'CASE-ACA-42',
                title: "Masculino, 62 años",
                category: "Territorio Arteria Cerebral Anterior",
                desc: "Paciente evaluado por inicio súbito de debilidad marcada en la pierna derecha y abulia. La fuerza en el miembro superior derecho es 4/5, mientras que en el inferior es 2/5. Incontinencia urinaria reciente.",
                lkw: "09:00 (hace 2.5h)",
                history: "HTA, Tabaquismo, Sedentarismo.",
                vitals: { bp: "172/95", hr: "78", sat: "96", gluc: "112" },
                correctNihss: 8,
                tnkEligible: true
            },
            'ACM-DOM': {
                id: 'CASE-ACM-IZQ',
                title: "Femenina, 55 años",
                category: "ACM Izquierda (Hemisferio Dominante)",
                desc: "Ingresa por hemiparesia derecha completa y afasia global (no expresa, no comprende). Desviación de la mirada hacia la izquierda.",
                lkw: "14:20 (hace 45 min)",
                history: "Fibrilación Auricular no anticoagulada, DM2.",
                vitals: { bp: "198/110", hr: "112", sat: "94", gluc: "145" },
                correctNihss: 22,
                tnkEligible: false // Requiere control de PA primero
            },
            'ACM-NON': {
                id: 'CASE-ACM-DER',
                title: "Masculino, 68 años",
                category: "ACM Derecha (Hemisferio No Dominante)",
                desc: "Hemiparesia izquierda, negligencia espacial izquierda marcada. El paciente niega que su brazo izquierdo le pertenezca (anosognosia).",
                lkw: "11:15 (hace 1.5h)",
                history: "Dislipidemia, Obesidad Grado I.",
                vitals: { bp: "165/90", hr: "82", sat: "98", gluc: "98" },
                correctNihss: 16,
                tnkEligible: true
            },
            'ACP': {
                id: 'CASE-ACP-V3',
                title: "Masculino, 70 años",
                category: "Arteria Cerebral Posterior",
                desc: "Consulta por visión borrosa. Al examen: hemianopsia homónima derecha con respeto macular. Refiere parestesias en hemicuerpo derecho. No presenta déficit motor.",
                lkw: "17:00 (hace 5h)",
                history: "Infarto previo (IAM hace 5 años), HTA.",
                vitals: { bp: "155/85", hr: "70", sat: "97", gluc: "105" },
                correctNihss: 4,
                tnkEligible: false // Fuera de ventana (5h)
            },
            'VERTEBRO': {
                id: 'CASE-VB-9',
                title: "Femenina, 48 años",
                category: "Fosa Posterior (Sist. Vertebro-Basilar)",
                desc: "Cuadro de vértigo súbito, ataxia severa (imposibilidad para la marcha) y diplopía. Disartria marcada y dificultad para deglutir.",
                lkw: "18:15 (hace 2h)",
                history: "Ninguno conocido. Usuario de anticonceptivos orales.",
                vitals: { bp: "140/80", hr: "90", sat: "99", gluc: "92" },
                correctNihss: 12,
                tnkEligible: true
            }
        };

        const NIHSS_ITEMS = [
            { id: '1a', title: '1a. Nivel de Conciencia (LOC)', options: ['Alerta', 'Somnoliento', 'Estuporoso', 'Coma'], points: [0, 1, 2, 3] },
            { id: '1b', title: '1b. LOC Preguntas (Mes y Edad)', options: ['Ambas correctas', 'Una correcta', 'Ninguna correcta'], points: [0, 1, 2] },
            { id: '1c', title: '1c. LOC Comandos (Ojos y Grip)', options: ['Ambos correctos', 'Uno correcto', 'Ninguno correcto'], points: [0, 1, 2] },
            { id: '2', title: '2. Mirada Conjugada', options: ['Normal', 'Parálisis parcial', 'Desviación forzada'], points: [0, 1, 2] },
            { id: '3', title: '3. Campos Visuales (Hemianopsia)', options: ['Sin pérdida', 'Hemianopsia parcial', 'Hemianopsia completa', 'Hemianopsia bilateral'], points: [0, 1, 2, 3] },
            { id: '4', title: '4. Parálisis Facial', options: ['Normal', 'Debilidad menor', 'Parálisis parcial', 'Parálisis completa'], points: [0, 1, 2, 3] },
            { id: '5a', title: '5a. Motor Brazo Izquierdo', options: ['Normal', 'Cae antes de 10s', 'Algún esfuerzo vs gravedad', 'Sin esfuerzo vs gravedad', 'Sin movimiento'], points: [0, 1, 2, 3, 4] },
            { id: '5b', title: '5b. Motor Brazo Derecho', options: ['Normal', 'Cae antes de 10s', 'Algún esfuerzo vs gravedad', 'Sin esfuerzo vs gravedad', 'Sin movimiento'], points: [0, 1, 2, 3, 4] },
            { id: '6a', title: '6a. Motor Pierna Izquierda', options: ['Normal', 'Cae antes de 5s', 'Algún esfuerzo vs gravedad', 'Sin esfuerzo vs gravedad', 'Sin movimiento'], points: [0, 1, 2, 3, 4] },
            { id: '6b', title: '6b. Motor Pierna Derecha', options: ['Normal', 'Cae antes de 5s', 'Algún esfuerzo vs gravedad', 'Sin esfuerzo vs gravedad', 'Sin movimiento'], points: [0, 1, 2, 3, 4] },
            { id: '7', title: '7. Ataxia de Miembros', options: ['Ausente', 'Presente en 1 miembro', 'Presente en 2 miembros'], points: [0, 1, 2] },
            { id: '8', title: '8. Sensibilidad', options: ['Normal', 'Pérdida leve a moderada', 'Pérdida severa'], points: [0, 1, 2] },
            { id: '9', title: '9. Lenguaje (Afasia)', options: ['Normal', 'Afasia leve-mod', 'Afasia severa', 'Global/Muda'], points: [0, 1, 2, 3] },
            { id: '10', title: '10. Disartria', options: ['Normal', 'Leve-mod', 'Severa/No entendible'], points: [0, 1, 2] },
            { id: '11', title: '11. Extinción e Inatención', options: ['Ausente', 'Parcial (Visual/Táctil)', 'Completa (Negligencia)'], points: [0, 1, 2] }
        ];

        // Variables de Estado
        let currentTerritory = null;
        let studentStats = { hits: 0, errors: 0 };
        let actionsDone = { tc: false, bp: false };
        let secondsElapsed = 0;
        let timerInterval = null;
        let evaluationScore = 0;

        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            initSupabaseSession();
            renderNihssForm();
            startTimer();
        });

        async function initSupabaseSession() {
            if (!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            const saveBtn = document.getElementById('btn-save-nihss');

            if (session) {
                currentUser = session.user;
                document.getElementById('user-display').innerText = currentUser.email.split('@')[0];
                console.log("Sesión activa Supabase:", currentUser.id);
                saveBtn.disabled = false;
                saveBtn.title = "Guardar evaluación en tu perfil";
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('grayscale');
                saveBtn.title = "Debes iniciar sesión para guardar tu progreso";
                console.warn("No hay sesión activa de Supabase.");
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            secondsElapsed = 0;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const h = Math.floor(secondsElapsed / 3600).toString().padStart(2, '0');
                const m = Math.floor((secondsElapsed % 3600) / 60).toString().padStart(2, '0');
                const s = (secondsElapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function renderNihssForm() {
            const container = document.getElementById('nihss-form-container');
            container.innerHTML = NIHSS_ITEMS.map(item => `
            <div class="bg-surface-light dark:bg-slate-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm transition-all">
                <h4 class="text-lg font-black mb-4">${item.title}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${item.options.map((opt, idx) => `
                        <label class="relative cursor-pointer group">
                            <input class="sr-only-input" name="${item.id}" type="radio" value="${item.points[idx]}" onchange="calculateScore()">
                            <div class="flex items-center gap-4 p-4 rounded-xl border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-slate-900 group-hover:border-primary/50 transition-all font-bold text-sm">
                                <div class="size-5 rounded-full border border-gray-300 dark:border-gray-600 radio-circle flex items-center justify-center">
                                    <div class="size-2 rounded-full bg-white opacity-0 radio-dot"></div>
                                </div>
                                <span class="size-6 bg-white dark:bg-slate-700 rounded text-[10px] flex items-center justify-center border">${item.points[idx]}</span>
                                <span>${opt}</span>
                            </div>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
        }

        function calculateScore() {
            let total = 0;
            NIHSS_ITEMS.forEach(item => {
                const selected = document.querySelector(`input[name="${item.id}"]:checked`);
                if (selected) total += parseInt(selected.value);
            });
            evaluationScore = total;
            document.getElementById('nihss-score-total').innerText = total;

            let interp = "Pendiente";
            if (total === 0) interp = "Sin Déficit";
            else if (total <= 4) interp = "ACV Menor (0-4)";
            else if (total <= 15) interp = "ACV Moderado (5-15)";
            else if (total <= 20) interp = "ACV Mod-Severo (16-20)";
            else interp = "ACV Severo (>20)";

            document.getElementById('nihss-interpretation').innerText = interp;
        }

        function selectTerritory(terr) {
            currentTerritory = terr;

            // UI Mapping Update
            document.querySelectorAll('.brain-area').forEach(el => el.classList.remove('active'));
            const elId = terr === 'ACM-DOM' ? 'btn-mca-dom' : terr === 'ACM-NON' ? 'btn-mca-non' : `btn-${terr.toLowerCase()}`;
            document.getElementById(elId).classList.add('active');

            // Load Case
            const caseData = CLINICAL_CASES[terr];
            document.getElementById('case-category').innerText = caseData.category;
            document.getElementById('patient-title').innerText = caseData.title;
            document.getElementById('case-desc').innerHTML = caseData.desc;
            document.getElementById('case-id').innerText = `ID: ${caseData.id}`;
            document.getElementById('val-lkw').innerText = caseData.lkw;
            document.getElementById('val-history').innerText = caseData.history;

            // Vitals
            const bpEl = document.getElementById('vital-bp');
            bpEl.innerText = caseData.vitals.bp;
            bpEl.classList.add('text-danger');
            document.getElementById('vital-hr').innerText = caseData.vitals.hr;
            document.getElementById('vital-sat').innerText = caseData.vitals.sat;
            document.getElementById('vital-gluc').innerText = caseData.vitals.gluc;

            // Reset state
            actionsDone = { tc: false, bp: false };
            hideBanner();
            resetNihssForm();
        }

        function performAction(type) {
            if (!currentTerritory) {
                alert("Selecciona un territorio primero.");
                return;
            }

            const banner = document.getElementById('status-banner');
            const currentCase = CLINICAL_CASES[currentTerritory];

            if (type === 'TC') {
                actionsDone.tc = true;
                showBanner("TC Simple: Sin signos de hemorragia aguda. Aspect score 10.", "bg-blue-50 text-blue-800 border-blue-500");
                addPoint(true);
            } else if (type === 'BP') {
                const bp = currentCase.vitals.bp;
                const sys = parseInt(bp.split('/')[0]);
                if (sys > 185) {
                    document.getElementById('vital-bp').innerText = "140/85";
                    document.getElementById('vital-bp').className = "text-2xl font-black text-success";
                    actionsDone.bp = true;
                    showBanner("PA Controlada con éxito (Labetalol IV).", "bg-green-50 text-green-800 border-green-500");
                    addPoint(true);
                } else {
                    showBanner("La PA ya se encuentra en rangos de seguridad.", "bg-gray-50 text-gray-800 border-gray-400");
                }
            } else if (type === 'TNK') {
                // Validación Médica Estricta
                if (!actionsDone.tc) {
                    showBanner("¡ERROR CRÍTICO! No puedes trombolizar sin descartar hemorragia por TC.", "bg-red-50 text-red-800 border-red-500");
                    addPoint(false);
                    return;
                }

                // Check BP eligibility (even if it was already fine in vitals)
                const sysNow = parseInt(document.getElementById('vital-bp').innerText.split('/')[0]);
                if (sysNow >= 185) {
                    showBanner("¡ERROR PROTOCOLO! Controla la PA antes de administrar TNK.", "bg-red-50 text-red-800 border-red-500");
                    addPoint(false);
                    return;
                }

                if (currentCase.tnkEligible) {
                    showBanner("Tenecteplase administrado (0.25mg/kg). Caso Resuelto Exitosamente.", "bg-green-50 text-green-800 border-green-500");
                    addPoint(true);
                } else {
                    showBanner("¡ADVERTENCIA! El paciente no era candidato óptimo (revisar tiempo de evolución o contraindicaciones).", "bg-warning/10 text-warning border-warning");
                    addPoint(false);
                }
            }
        }

        function addPoint(isHit) {
            if (isHit) studentStats.hits++;
            else studentStats.errors++;

            document.getElementById('hit-count').innerText = studentStats.hits;
            document.getElementById('error-count').innerText = studentStats.errors;

            const total = studentStats.hits + studentStats.errors;
            document.getElementById('hit-progress').style.width = `${(studentStats.hits / total) * 100}%`;
            document.getElementById('error-progress').style.width = `${(studentStats.errors / total) * 100}%`;
        }

        function showBanner(msg, classes) {
            const banner = document.getElementById('status-banner');
            banner.innerText = msg;
            banner.className = `p-4 rounded-2xl border-l-4 font-bold text-sm ${classes}`;
            banner.classList.remove('hidden');
        }

        function hideBanner() {
            document.getElementById('status-banner').classList.add('hidden');
        }

        function resetNihssForm() {
            document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
            calculateScore();
        }

        function resetCurrentCase() {
            if (currentTerritory) selectTerritory(currentTerritory);
        }

        // SUPABASE DATA SAVING
        async function saveEvaluation() {
            if (!currentTerritory) {
                alert("Elige un caso primero.");
                return;
            }

            const button = document.getElementById('btn-save-nihss');
            button.disabled = true;
            button.innerText = "SINCRONIZANDO...";

            if (!currentUser) {
                alert("ERROR: Debes iniciar sesión para guardar esta evaluación y recibir puntos.");
                button.disabled = true;
                button.innerText = "BLOQUEADO (SIN SESIÓN)";
                return;
            }

            try {
                const evaluationData = {
                    user_id: currentUser.id,
                    case_id: CLINICAL_CASES[currentTerritory].id,
                    nihss_score: evaluationScore,
                    hits: studentStats.hits,
                    errors: studentStats.errors,
                    time_taken: secondsElapsed,
                    territory: currentTerritory
                };

                console.log("Saving to Supabase:", evaluationData);

                if (supabaseClient) {
                    // 1. Guardar evaluación NIHSS
                    const { error: nihssErr } = await supabaseClient
                        .from('nihss_evaluations')
                        .insert([evaluationData]);

                    if (nihssErr) throw nihssErr;

                    // 2. Guardar respuesta del estudiante (items específicos)
                    const itemsData = NIHSS_ITEMS.map(item => {
                        const sel = document.querySelector(`input[name="${item.id}"]:checked`);
                        return {
                            user_id: currentUser.id,
                            case_id: CLINICAL_CASES[currentTerritory].id,
                            item_id: item.id,
                            selected_value: sel ? parseInt(sel.value) : -1
                        };
                    });

                    const { error: respErr } = await supabaseClient
                        .from('student_responses')
                        .insert(itemsData);

                    if (respErr) throw respErr;
                } else {
                    // Simulación si no hay cliente (para testing offline)
                    await new Promise(r => setTimeout(r, 1000));
                    console.warn("Supabase no configurado. Simulación exitosa.");
                }

                alert("Evolución guardada y puntos asignados a tu perfil.");
            } catch (err) {
                console.error(err);
                alert("Error al guardar: " + err.message);
            } finally {
                button.disabled = false;
                button.innerText = "GUARDAR EVALUACIÓN";
            }
        }
    </script>

</body>

</html>